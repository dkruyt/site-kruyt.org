<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>ETAG headers in a load balanced farm | Dennis Kruyt</title>
<meta name="keywords" content="etag, server, header, nginx, web" />
<meta name="description" content="When I was looking at some Nginx caching settings to improve them on a load balanced static content farm. I noticed that the etag headers difference between servers for the same file when they should be the same.
So first what is a etag header?
From WikipediA
 The ETag or entity tag is part of HTTP, the protocol for the World Wide Web. It is one of several mechanisms that HTTP provides for web cache validation, which allows a client to make conditional requests.">
<meta name="author" content="Dennis Kruyt">
<link rel="canonical" href="https://kruyt.org/etag/" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.c88963fe2d79462000fd0fb1b3737783c32855d340583e4523343f8735c787f0.css" integrity="sha256-yIlj/i15RiAA/Q&#43;xs3N3g8MoVdNAWD5FIzQ/hzXHh/A=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js" integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5&#43;kdJvBz5iKbt6B5PJI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://kruyt.org/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://kruyt.org/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://kruyt.org/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://kruyt.org/apple-touch-icon.png">
<link rel="mask-icon" href="https://kruyt.org/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<meta name="generator" content="Hugo 0.89.4" />
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="ETAG headers in a load balanced farm" />
<meta property="og:description" content="When I was looking at some Nginx caching settings to improve them on a load balanced static content farm. I noticed that the etag headers difference between servers for the same file when they should be the same.
So first what is a etag header?
From WikipediA
 The ETag or entity tag is part of HTTP, the protocol for the World Wide Web. It is one of several mechanisms that HTTP provides for web cache validation, which allows a client to make conditional requests." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://kruyt.org/etag/" />
<meta property="og:image" content="https://kruyt.org/images/2018/06/837-imported-1443570304-837-imported-1443554777-default-headers-pages.png" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2018-06-29T18:28:29&#43;00:00" />
<meta property="article:modified_time" content="2018-06-29T18:28:29&#43;00:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://kruyt.org/images/2018/06/837-imported-1443570304-837-imported-1443554777-default-headers-pages.png" />
<meta name="twitter:title" content="ETAG headers in a load balanced farm"/>
<meta name="twitter:description" content="When I was looking at some Nginx caching settings to improve them on a load balanced static content farm. I noticed that the etag headers difference between servers for the same file when they should be the same.
So first what is a etag header?
From WikipediA
 The ETag or entity tag is part of HTTP, the protocol for the World Wide Web. It is one of several mechanisms that HTTP provides for web cache validation, which allows a client to make conditional requests."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://kruyt.org/post/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "ETAG headers in a load balanced farm",
      "item": "https://kruyt.org/etag/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "ETAG headers in a load balanced farm",
  "name": "ETAG headers in a load balanced farm",
  "description": "When I was looking at some Nginx caching settings to improve them on a load balanced static content farm. I noticed that the etag headers difference between servers for the same file when they should be the same.\nSo first what is a etag header?\nFrom WikipediA\n The ETag or entity tag is part of HTTP, the protocol for the World Wide Web. It is one of several mechanisms that HTTP provides for web cache validation, which allows a client to make conditional requests.",
  "keywords": [
    "etag", "server", "header", "nginx", "web"
  ],
  "articleBody": "When I was looking at some Nginx caching settings to improve them on a load balanced static content farm. I noticed that the etag headers difference between servers for the same file when they should be the same.\nSo first what is a etag header?\nFrom WikipediA\n The ETag or entity tag is part of HTTP, the protocol for the World Wide Web. It is one of several mechanisms that HTTP provides for web cache validation, which allows a client to make conditional requests. This allows caches to be more efficient, and saves bandwidth, as a web server does not need to send a full response if the content has not changed.\n When I ask the headers of the same file from different servers, note the x-server. I see the etag header is not the same.\ndennis@colossus:~ curl 'https://server/5.jpg' -I HTTP/2 200 server: nginx content-length: 23715 last-modified: Mon, 14 May 2018 08:50:26 GMT etag: \"5af94dd2-5ca3\" x-server: a-stat01 dennis@colossus:~ curl 'https://server/5.jpg' -I HTTP/2 200 server: nginx content-length: 23715 last-modified: Mon, 14 May 2018 12:16:14 GMT etag: \"5af97e0e-5ca3\" x-server: a-stat02 A quick md5sum learns that both files are the same on both server.\nroot@a-stat01:# md5sum 5.jpg d968155f06057025f4cc8723ac2c764f 5.jpg root@a-stat02:# md5sum 5.jpg d968155f06057025f4cc8723ac2c764f 5.jpg So why the etag is different on both servers then?\nI am here using a Nginx server. And every webserver generates a different kind of etag header. So we need to look in the Nginx source code. There we can see how the etag value is generated. It uses the last modification time and the content length.\netag-value.len = ngx_sprintf(etag-value.data, \"\\\"%xT-%xO\\\"\", r-headers_out.last_modified_time, r-headers_out.content_length_n) So, when we look at the headers earlier we see the modification times differs. This is because the files are uploaded to each server separately.\nSo uploading the files to each server wont work unless you preserve modification times while uploading but this not the best approach. A better approach is to upload to one server and the use rsync with -t or something maybe like a glusterfs setup, so that all servers have the same content and modification times and thus the same etag value.\n",
  "wordCount" : "350",
  "inLanguage": "en",
  "image":"https://kruyt.org/images/2018/06/837-imported-1443570304-837-imported-1443554777-default-headers-pages.png","datePublished": "2018-06-29T18:28:29Z",
  "dateModified": "2018-06-29T18:28:29Z",
  "author":{
    "@type": "Person",
    "name": "Dennis Kruyt"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://kruyt.org/etag/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Dennis Kruyt",
    "logo": {
      "@type": "ImageObject",
      "url": "https://kruyt.org/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://kruyt.org/" accesskey="h" title="Dennis Kruyt (Alt + H)">Dennis Kruyt</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      ETAG headers in a load balanced farm
    </h1>
    <div class="post-meta"><span title='2018-06-29 18:28:29 +0000 UTC'>June 29, 2018</span>&nbsp;·&nbsp;Dennis Kruyt

</div>
  </header> 
<figure class="entry-cover"><img loading="lazy" src="https://kruyt.org/images/2018/06/837-imported-1443570304-837-imported-1443554777-default-headers-pages.png" alt="">
        
</figure>
  <div class="post-content"><p>When I was looking at some Nginx caching settings to improve them on a load balanced static content farm. I noticed that the etag headers difference between servers for the same file when they should be the same.</p>
<p>So first what is a etag header?</p>
<p><em>From WikipediA</em></p>
<blockquote>
<p>The ETag or entity tag is part of HTTP, the protocol for the World Wide Web. It is one of several mechanisms that HTTP provides for web cache validation, which allows a client to make conditional requests. This allows caches to be more efficient, and saves bandwidth, as a web server does not need to send a full response if the content has not changed.</p>
</blockquote>
<p>When I ask the headers of the same file from different servers, note the x-server. I see the etag header is not the same.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">dennis@colossus:~&gt; curl <span style="color:#e6db74">&#39;https://server/5.jpg&#39;</span> -I
HTTP/2 <span style="color:#ae81ff">200</span>
server: nginx
content-length: <span style="color:#ae81ff">23715</span>
last-modified: Mon, <span style="color:#ae81ff">14</span> May <span style="color:#ae81ff">2018</span> 08:50:26 GMT
etag: <span style="color:#e6db74">&#34;5af94dd2-5ca3&#34;</span>
x-server: a-stat01
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">dennis@colossus:~&gt; curl <span style="color:#e6db74">&#39;https://server/5.jpg&#39;</span> -I
HTTP/2 <span style="color:#ae81ff">200</span>
server: nginx
content-length: <span style="color:#ae81ff">23715</span>
last-modified: Mon, <span style="color:#ae81ff">14</span> May <span style="color:#ae81ff">2018</span> 12:16:14 GMT
etag: <span style="color:#e6db74">&#34;5af97e0e-5ca3&#34;</span>
x-server: a-stat02
</code></pre></div><p>A quick md5sum learns that both files are the same on both server.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@a-stat01:# md5sum 5.jpg
d968155f06057025f4cc8723ac2c764f  5.jpg
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@a-stat02:# md5sum 5.jpg
d968155f06057025f4cc8723ac2c764f  5.jpg
</code></pre></div><p>So why the etag is different on both servers then?</p>
<p>I am here using a Nginx server. And every webserver generates a different kind of etag header. So we need to look in the Nginx source code. There we can see how the etag value is generated.
It uses the last modification time and the content length.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">etag</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">value</span>.<span style="color:#a6e22e">len</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ngx_sprintf</span>(<span style="color:#a6e22e">etag</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">value</span>.<span style="color:#a6e22e">data</span>, <span style="color:#e6db74">&#34;\&#34;%xT-%xO\&#34;&#34;</span>,
                            <span style="color:#a6e22e">r</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">headers_out</span>.<span style="color:#a6e22e">last_modified_time</span>,
                            <span style="color:#a6e22e">r</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">headers_out</span>.<span style="color:#a6e22e">content_length_n</span>)
</code></pre></div><p>So, when we look at the headers earlier we see the modification times differs. This is because the files are uploaded to each server separately.</p>
<p>So uploading the files to each server wont work unless you preserve modification times while uploading but this not the best approach. A better approach is to upload to one server and the use rsync with -t or something maybe like a glusterfs setup, so that all servers have the same content and modification times and thus the same etag value.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://kruyt.org/tags/etag/">etag</a></li>
      <li><a href="https://kruyt.org/tags/server/">server</a></li>
      <li><a href="https://kruyt.org/tags/header/">header</a></li>
      <li><a href="https://kruyt.org/tags/nginx/">nginx</a></li>
      <li><a href="https://kruyt.org/tags/web/">web</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2021 <a href="https://kruyt.org/">Dennis Kruyt</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
