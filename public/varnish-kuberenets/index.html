<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Varnish in Kubernetes | Dennis Kruyt</title>
<meta name="keywords" content="varnish, cache, kubernetes" />
<meta name="description" content="This is a simple minimal but highly configurable Varnish caching service for Kubernetes. This should be placed between your ingress and your application service.
  simple setup
  It can be used in combination with multiple ingresses and application services at the same time.
  multiple ingress and services
  Setup Apply the following yaml file, replicas and environment variables can be adjusted to your need.">
<meta name="author" content="Dennis Kruyt">
<link rel="canonical" href="https://kruyt.org/varnish-kuberenets/" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.c88963fe2d79462000fd0fb1b3737783c32855d340583e4523343f8735c787f0.css" integrity="sha256-yIlj/i15RiAA/Q&#43;xs3N3g8MoVdNAWD5FIzQ/hzXHh/A=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js" integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5&#43;kdJvBz5iKbt6B5PJI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://kruyt.org/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://kruyt.org/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://kruyt.org/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://kruyt.org/apple-touch-icon.png">
<link rel="mask-icon" href="https://kruyt.org/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<meta name="generator" content="Hugo 0.89.4" />
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Varnish in Kubernetes" />
<meta property="og:description" content="This is a simple minimal but highly configurable Varnish caching service for Kubernetes. This should be placed between your ingress and your application service.
  simple setup
  It can be used in combination with multiple ingresses and application services at the same time.
  multiple ingress and services
  Setup Apply the following yaml file, replicas and environment variables can be adjusted to your need." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://kruyt.org/varnish-kuberenets/" />
<meta property="og:image" content="https://kruyt.org/images/2020/09/Webp.net-resizeimage.jpg" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2020-09-15T18:50:45&#43;00:00" />
<meta property="article:modified_time" content="2020-09-15T18:50:45&#43;00:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://kruyt.org/images/2020/09/Webp.net-resizeimage.jpg" />
<meta name="twitter:title" content="Varnish in Kubernetes"/>
<meta name="twitter:description" content="This is a simple minimal but highly configurable Varnish caching service for Kubernetes. This should be placed between your ingress and your application service.
  simple setup
  It can be used in combination with multiple ingresses and application services at the same time.
  multiple ingress and services
  Setup Apply the following yaml file, replicas and environment variables can be adjusted to your need."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://kruyt.org/post/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Varnish in Kubernetes",
      "item": "https://kruyt.org/varnish-kuberenets/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Varnish in Kubernetes",
  "name": "Varnish in Kubernetes",
  "description": "This is a simple minimal but highly configurable Varnish caching service for Kubernetes. This should be placed between your ingress and your application service.\n  simple setup\n  It can be used in combination with multiple ingresses and application services at the same time.\n  multiple ingress and services\n  Setup Apply the following yaml file, replicas and environment variables can be adjusted to your need.",
  "keywords": [
    "varnish", "cache", "kubernetes"
  ],
  "articleBody": "  This is a simple minimal but highly configurable Varnish caching service for Kubernetes. This should be placed between your ingress and your application service.\n  simple setup\n  It can be used in combination with multiple ingresses and application services at the same time.\n  multiple ingress and services\n  Setup Apply the following yaml file, replicas and environment variables can be adjusted to your need. This will deploy the Varnish service and Varnish proxy pods. The container is now based up on Alpine Linux and Varnish 6.4\napiVersion: v1 kind: Service metadata: name: varnish-svc namespace: default spec: ports: - name: \"http\" port: 80 selector: app: varnish-proxy --- apiVersion: apps/v1 kind: Deployment metadata: name: varnish-proxy namespace: default spec: replicas: 2 selector: matchLabels: app: varnish-proxy template: metadata: name: varnish-proxy labels: app: varnish-proxy spec: volumes: - name: varnish-config configMap: name: varnish-vcl items: - key: default.vcl path: default.vcl - name: varnish-secret secret: secretName: varnish-secret containers: - name: varnish image: dkruyt/varnish:alpine imagePullPolicy: Always env: - name: CACHE_SIZE value: 128m - name: VCL_CONFIG value: /etc/varnish/configmap/default.vcl - name: SECRET_FILE value: /etc/varnish/k8s-secret/secret volumeMounts: - name: varnish-config mountPath: /etc/varnish/configmap - name: varnish-secret mountPath: /etc/varnish/k8s-secret ports: - containerPort: 80 Create a secret for Varnish cli admin operations\nkubectl create secret generic varnish-secret --from-literal=secret=$(head -c32 /dev/urandom | base64) Varnish vcl config You will need to provide your custom vcl file, you can put this in a configmap the following way.\nkubectl create configmap varnish-vcl --from-file=default.vcl A very simple vcl example config file, here it wil take the request hostname and transfer it to a backend, in the backend we define the Kubernetes service name. No need for multiple backend, because Kubernetes does the load balancing if there are multiple pods defined.\nvcl 4.0; import directors; import std; backend site1 { .host = \"service-name1\"; .port = \"80\"; } backend site2 { .host = \"service-name2\"; .port = \"80\"; } sub vcl_recv { if (req.http.host == \"www.site1.com\") { set req.backend_hint = site1; } if (req.http.host == \"www.site2.org\") { set req.backend_hint = site2; } } Setup Ingress point service to Varnish In your ingress, point to the varnish service. Multiple ingresses can be all pointing the the same varnish service, you will need to apply the proper routing in the varnish config to point everything to the correct application services.\napiVersion: networking.k8s.io/v1beta1 kind: Ingress metadata: name: site1 spec: rules: - host: www.site1.com http: paths: - path: backend: serviceName: varnish-svc servicePort: 80 - host: www.site2.org http: paths: - path: backend: serviceName: varnish-svc servicePort: 80 Optional Metrics: telegraf sidecar I am using Telegraf, InfluxDB and Grafana everywhere for metrics.\nIf you want metrics from Varnish, I created a sidecar container that will pull the metrics from Varnish and send it to InfluxDB. Don’t forget to adjust the hostAlias in the yaml file to point it to your InfluxDB instance.\napiVersion: v1 kind: Service metadata: name: varnish-svc namespace: default spec: ports: - name: \"http\" port: 80 selector: app: varnish-proxy --- apiVersion: apps/v1 kind: Deployment metadata: name: varnish-proxy namespace: default spec: replicas: 2 selector: matchLabels: app: varnish-proxy template: metadata: name: varnish-proxy labels: app: varnish-proxy spec: hostAliases: - ip: \"192.168.66.168\" hostnames: - \"influxdb\" volumes: - name: varnish-config configMap: name: varnish-vcl items: - key: default.vcl path: default.vcl - name: varnish-secret secret: secretName: varnish-secret - name: shared-data emptyDir: {} containers: - name: varnish image: dkruyt/varnish:alpine imagePullPolicy: Always env: - name: CACHE_SIZE value: 128m - name: VCL_CONFIG value: /etc/varnish/configmap/default.vcl - name: SECRET_FILE value: /etc/varnish/k8s-secret/secret - name: VARNISHD_PARAMS value: -p default_ttl=3600 -p default_grace=3600 -T localhost:6082 volumeMounts: - name: varnish-config mountPath: /etc/varnish/configmap - name: varnish-secret mountPath: /etc/varnish/k8s-secret - name: shared-data mountPath: /var/lib/varnish ports: - containerPort: 80 - name: telegraf image: dkruyt/telegraf-varnish:alpine imagePullPolicy: Always volumeMounts: - name: varnish-secret mountPath: /etc/varnish/k8s-secret - name: shared-data mountPath: /var/lib/varnish readOnly: true ",
  "wordCount" : "608",
  "inLanguage": "en",
  "image":"https://kruyt.org/images/2020/09/Webp.net-resizeimage.jpg","datePublished": "2020-09-15T18:50:45Z",
  "dateModified": "2020-09-15T18:50:45Z",
  "author":{
    "@type": "Person",
    "name": "Dennis Kruyt"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://kruyt.org/varnish-kuberenets/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Dennis Kruyt",
    "logo": {
      "@type": "ImageObject",
      "url": "https://kruyt.org/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://kruyt.org/" accesskey="h" title="Dennis Kruyt (Alt + H)">Dennis Kruyt</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      Varnish in Kubernetes
    </h1>
    <div class="post-meta"><span title='2020-09-15 18:50:45 +0000 UTC'>September 15, 2020</span>&nbsp;·&nbsp;Dennis Kruyt

</div>
  </header> 
<figure class="entry-cover"><img loading="lazy" src="https://kruyt.org/images/2020/09/Webp.net-resizeimage.jpg" alt="">
        
</figure>
  <div class="post-content"><figure>
    <img loading="lazy" src="/images/2020/09/image-1.png"/> 
</figure>

<p>This is a simple minimal but highly configurable Varnish caching service for Kubernetes. This should be placed between your ingress and your application service.</p>
<figure>
    <img loading="lazy" src="/images/2020/09/image-4.png"
         alt="simple setup"/> <figcaption>
            <p>simple setup</p>
        </figcaption>
</figure>

<p>It can be used in combination with multiple ingresses and application services at the same time.</p>
<figure>
    <img loading="lazy" src="/images/2020/09/image-6.png"
         alt="multiple ingress and services"/> <figcaption>
            <p>multiple ingress and services</p>
        </figcaption>
</figure>

<h3 id="setup">Setup<a hidden class="anchor" aria-hidden="true" href="#setup">#</a></h3>
<p>Apply the following yaml file, replicas and environment variables can be adjusted to your need. This will deploy the Varnish service and Varnish proxy pods. The container is now based up on Alpine Linux and Varnish 6.4</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">varnish-svc</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">ports</span>:
  - <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;http&#34;</span>
    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">varnish-proxy</span>
---
<span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">varnish-proxy</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">2</span>
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">matchLabels</span>:
      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">varnish-proxy</span>
  <span style="color:#f92672">template</span>:
    <span style="color:#f92672">metadata</span>:
      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">varnish-proxy</span>
      <span style="color:#f92672">labels</span>:
        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">varnish-proxy</span>
    <span style="color:#f92672">spec</span>:
      <span style="color:#f92672">volumes</span>:
        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">varnish-config</span>
          <span style="color:#f92672">configMap</span>:
            <span style="color:#f92672">name</span>: <span style="color:#ae81ff">varnish-vcl</span>
            <span style="color:#f92672">items</span>:
              - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">default.vcl</span>
                <span style="color:#f92672">path</span>: <span style="color:#ae81ff">default.vcl</span>
        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">varnish-secret</span>
          <span style="color:#f92672">secret</span>:
            <span style="color:#f92672">secretName</span>: <span style="color:#ae81ff">varnish-secret</span>
      <span style="color:#f92672">containers</span>:
      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">varnish</span>
        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">dkruyt/varnish:alpine</span>
        <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">Always</span>
        <span style="color:#f92672">env</span>:
        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">CACHE_SIZE</span>
          <span style="color:#f92672">value</span>: <span style="color:#ae81ff">128m</span>
        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">VCL_CONFIG</span>
          <span style="color:#f92672">value</span>: <span style="color:#ae81ff">/etc/varnish/configmap/default.vcl</span>
        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">SECRET_FILE</span>
          <span style="color:#f92672">value</span>: <span style="color:#ae81ff">/etc/varnish/k8s-secret/secret</span>
        <span style="color:#f92672">volumeMounts</span>:
          - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">varnish-config</span>
            <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/etc/varnish/configmap</span>
          - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">varnish-secret</span>
            <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/etc/varnish/k8s-secret</span>
        <span style="color:#f92672">ports</span>:
        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>

</code></pre></div><p>Create a secret for Varnish cli admin operations</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl create secret generic varnish-secret --from-literal<span style="color:#f92672">=</span>secret<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>head -c32 /dev/urandom  | base64<span style="color:#66d9ef">)</span>

</code></pre></div><h3 id="varnish-vcl-config">Varnish vcl config<a hidden class="anchor" aria-hidden="true" href="#varnish-vcl-config">#</a></h3>
<p>You will need to provide your custom vcl file, you can put this in a configmap the following way.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl create configmap varnish-vcl --from-file<span style="color:#f92672">=</span>default.vcl

</code></pre></div><p>A very simple vcl example config file, here it wil take the request hostname and transfer it to a backend, in the backend we define the Kubernetes service name. No need for multiple backend, because Kubernetes does the load balancing if there are multiple pods defined.</p>
<pre tabindex="0"><code>vcl 4.0;

import directors;
import std;


backend site1 {
        .host = &quot;service-name1&quot;;
        .port = &quot;80&quot;;

}

backend site2 {
        .host = &quot;service-name2&quot;;
        .port = &quot;80&quot;;
}

sub vcl_recv {

   if (req.http.host == &quot;www.site1.com&quot;) {
        set req.backend_hint = site1;
    }
    if (req.http.host == &quot;www.site2.org&quot;) {
        set req.backend_hint = site2;
    }
}

</code></pre><h3 id="setup-ingress-point-service-to-varnish">Setup Ingress point service to Varnish<a hidden class="anchor" aria-hidden="true" href="#setup-ingress-point-service-to-varnish">#</a></h3>
<p>In your ingress, point to the varnish service. Multiple ingresses can be all pointing the the same varnish service, you will need to apply the proper routing in the varnish config to point everything to the correct application services.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">networking.k8s.io/v1beta1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Ingress</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">site1</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">rules</span>:
  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">www.site1.com</span>
    <span style="color:#f92672">http</span>:
      <span style="color:#f92672">paths</span>:
      - <span style="color:#f92672">path</span>:
        <span style="color:#f92672">backend</span>:
          <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">varnish-svc</span>
          <span style="color:#f92672">servicePort</span>: <span style="color:#ae81ff">80</span>
  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">www.site2.org</span>
    <span style="color:#f92672">http</span>:
      <span style="color:#f92672">paths</span>:
      - <span style="color:#f92672">path</span>:
        <span style="color:#f92672">backend</span>:
          <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">varnish-svc</span>
          <span style="color:#f92672">servicePort</span>: <span style="color:#ae81ff">80</span>

</code></pre></div><h3 id="optional-metrics-telegraf-sidecar">Optional Metrics: telegraf sidecar<a hidden class="anchor" aria-hidden="true" href="#optional-metrics-telegraf-sidecar">#</a></h3>
<p>I am using Telegraf, InfluxDB and Grafana everywhere for metrics.</p>
<p>If you want metrics from Varnish, I created a sidecar container that will pull the metrics from Varnish and send it to InfluxDB. Don&rsquo;t forget to adjust the hostAlias in the yaml file to point it to your InfluxDB instance.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">varnish-svc</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">ports</span>:
  - <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;http&#34;</span>
    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">varnish-proxy</span>
---
<span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">varnish-proxy</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">2</span>
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">matchLabels</span>:
      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">varnish-proxy</span>
  <span style="color:#f92672">template</span>:
    <span style="color:#f92672">metadata</span>:
      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">varnish-proxy</span>
      <span style="color:#f92672">labels</span>:
        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">varnish-proxy</span>
    <span style="color:#f92672">spec</span>:
      <span style="color:#f92672">hostAliases</span>:
       - <span style="color:#f92672">ip</span>: <span style="color:#e6db74">&#34;192.168.66.168&#34;</span>
         <span style="color:#f92672">hostnames</span>:
         - <span style="color:#e6db74">&#34;influxdb&#34;</span>
      <span style="color:#f92672">volumes</span>:
        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">varnish-config</span>
          <span style="color:#f92672">configMap</span>:
            <span style="color:#f92672">name</span>: <span style="color:#ae81ff">varnish-vcl</span>
            <span style="color:#f92672">items</span>:
              - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">default.vcl</span>
                <span style="color:#f92672">path</span>: <span style="color:#ae81ff">default.vcl</span>
        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">varnish-secret</span>
          <span style="color:#f92672">secret</span>:
            <span style="color:#f92672">secretName</span>: <span style="color:#ae81ff">varnish-secret</span>
        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">shared-data</span>
          <span style="color:#f92672">emptyDir</span>: {}
      <span style="color:#f92672">containers</span>:
      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">varnish</span>
        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">dkruyt/varnish:alpine</span>
        <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">Always</span>
        <span style="color:#f92672">env</span>:
        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">CACHE_SIZE</span>
          <span style="color:#f92672">value</span>: <span style="color:#ae81ff">128m</span>
        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">VCL_CONFIG</span>
          <span style="color:#f92672">value</span>: <span style="color:#ae81ff">/etc/varnish/configmap/default.vcl</span>
        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">SECRET_FILE</span>
          <span style="color:#f92672">value</span>: <span style="color:#ae81ff">/etc/varnish/k8s-secret/secret</span>
        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">VARNISHD_PARAMS</span>
          <span style="color:#f92672">value</span>: -<span style="color:#ae81ff">p default_ttl=3600 -p default_grace=3600 -T localhost:6082</span>
        <span style="color:#f92672">volumeMounts</span>:
          - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">varnish-config</span>
            <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/etc/varnish/configmap</span>
          - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">varnish-secret</span>
            <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/etc/varnish/k8s-secret</span>
          - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">shared-data</span>
            <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/var/lib/varnish</span>
        <span style="color:#f92672">ports</span>:
        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">telegraf</span>
        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">dkruyt/telegraf-varnish:alpine</span>
        <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">Always</span>
        <span style="color:#f92672">volumeMounts</span>:
          - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">varnish-secret</span>
            <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/etc/varnish/k8s-secret</span>
          - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">shared-data</span>
            <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/var/lib/varnish</span>
            <span style="color:#f92672">readOnly</span>: <span style="color:#66d9ef">true</span>
</code></pre></div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://kruyt.org/tags/varnish/">varnish</a></li>
      <li><a href="https://kruyt.org/tags/cache/">cache</a></li>
      <li><a href="https://kruyt.org/tags/kubernetes/">kubernetes</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2021 <a href="https://kruyt.org/">Dennis Kruyt</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
