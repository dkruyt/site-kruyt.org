<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Migrate from Docker to Containerd in Kubernetes | Dennis Kruyt</title>
<meta name="keywords" content="kubernetes, kubelet, containerd, deprecated, docker, dockershim, 1.22, cri, migrate, 1.20" />
<meta name="description" content="Kubernetes is deprecating Docker as a container runtime after v1.20. Don&rsquo;t Panic üò± Docker containers are still supported, but the dockershim/Docker, the layer between Kubernetes and containerd is deprecated and will be removed from version 1.22&#43;.
Don‚Äôt Panic: Kubernetes and Docker Authors: Jorge Castro, Duffie Cooley, Kat Cosgrove, Justin Garrison, Noah Kantrowitz, Bob Killen, Rey Lejano, Dan ‚ÄúPOP‚Äù Papandrea, Jeffrey Sica, Davanum ‚ÄúDims‚Äù Srinivas\nKubernetes is deprecating Docker as a container runtime after v1.">
<meta name="author" content="Dennis Kruyt">
<link rel="canonical" href="https://kruyt.org/post/2021/migrate-docker-containerd-kubernetes/" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.c88963fe2d79462000fd0fb1b3737783c32855d340583e4523343f8735c787f0.css" integrity="sha256-yIlj/i15RiAA/Q&#43;xs3N3g8MoVdNAWD5FIzQ/hzXHh/A=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js" integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5&#43;kdJvBz5iKbt6B5PJI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://kruyt.org/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://kruyt.org/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://kruyt.org/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://kruyt.org/apple-touch-icon.png">
<link rel="mask-icon" href="https://kruyt.org/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<meta name="generator" content="Hugo 0.89.4" />
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Migrate from Docker to Containerd in Kubernetes" />
<meta property="og:description" content="Kubernetes is deprecating Docker as a container runtime after v1.20. Don&rsquo;t Panic üò± Docker containers are still supported, but the dockershim/Docker, the layer between Kubernetes and containerd is deprecated and will be removed from version 1.22&#43;.
Don‚Äôt Panic: Kubernetes and Docker Authors: Jorge Castro, Duffie Cooley, Kat Cosgrove, Justin Garrison, Noah Kantrowitz, Bob Killen, Rey Lejano, Dan ‚ÄúPOP‚Äù Papandrea, Jeffrey Sica, Davanum ‚ÄúDims‚Äù Srinivas\nKubernetes is deprecating Docker as a container runtime after v1." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://kruyt.org/post/2021/migrate-docker-containerd-kubernetes/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-03-16T21:17:54&#43;00:00" />
<meta property="article:modified_time" content="2021-03-16T21:17:54&#43;00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Migrate from Docker to Containerd in Kubernetes"/>
<meta name="twitter:description" content="Kubernetes is deprecating Docker as a container runtime after v1.20. Don&rsquo;t Panic üò± Docker containers are still supported, but the dockershim/Docker, the layer between Kubernetes and containerd is deprecated and will be removed from version 1.22&#43;.
Don‚Äôt Panic: Kubernetes and Docker Authors: Jorge Castro, Duffie Cooley, Kat Cosgrove, Justin Garrison, Noah Kantrowitz, Bob Killen, Rey Lejano, Dan ‚ÄúPOP‚Äù Papandrea, Jeffrey Sica, Davanum ‚ÄúDims‚Äù Srinivas\nKubernetes is deprecating Docker as a container runtime after v1."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://kruyt.org/post/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Migrate from Docker to Containerd in Kubernetes",
      "item": "https://kruyt.org/post/2021/migrate-docker-containerd-kubernetes/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Migrate from Docker to Containerd in Kubernetes",
  "name": "Migrate from Docker to Containerd in Kubernetes",
  "description": "Kubernetes is deprecating Docker as a container runtime after v1.20. Don\u0026rsquo;t Panic üò± Docker containers are still supported, but the dockershim/Docker, the layer between Kubernetes and containerd is deprecated and will be removed from version 1.22+.\nDon‚Äôt Panic: Kubernetes and Docker Authors: Jorge Castro, Duffie Cooley, Kat Cosgrove, Justin Garrison, Noah Kantrowitz, Bob Killen, Rey Lejano, Dan ‚ÄúPOP‚Äù Papandrea, Jeffrey Sica, Davanum ‚ÄúDims‚Äù Srinivas\\nKubernetes is deprecating Docker as a container runtime after v1.",
  "keywords": [
    "kubernetes", "kubelet", "containerd", "deprecated", "docker", "dockershim", "1.22", "cri", "migrate", "1.20"
  ],
  "articleBody": "Kubernetes is deprecating Docker as a container runtime after v1.20. Don‚Äôt Panic üò± Docker containers are still supported, but the dockershim/Docker, the layer between Kubernetes and containerd is deprecated and will be removed from version 1.22+.\nDon‚Äôt Panic: Kubernetes and Docker Authors: Jorge Castro, Duffie Cooley, Kat Cosgrove, Justin Garrison, Noah Kantrowitz, Bob Killen, Rey Lejano, Dan ‚ÄúPOP‚Äù Papandrea, Jeffrey Sica, Davanum ‚ÄúDims‚Äù Srinivas\\nKubernetes is deprecating Docker as a container runtime after v1.20.\\nYou do not need to panic. It‚Äôs not as dramatic as it sounds.\\nT‚Ä¶ Wednesday, December 02, 2020 Kubernetes      So if you are running docker you need to change to a supported container runtime interface (CRI). containerd is a good choice, it is already running on your Kubernetes node if you are running Docker.\nAn extra advantage is there is less overhead, there is no docker-shim and Docker translation layers as you can see is this diagram.\n  change from docker shim to containerd CRI\n  How to migrate First we check what container runtime is currently running. We do this with kubectl get nodes -o wide\nAs we can see we are runnig Docker as runtime.\nNAME STATUS ROLES AGE VERSION INTERNAL-IP EXTERNAL-IP OS-IMAGE KERNEL-VERSION CONTAINER-RUNTIME k8s-cn01 Ready control-plane,master 78m v1.20.4 10.65.79.164  Ubuntu 20.04.2 LTS 5.4.0-67-generic docker://20.10.5 k8s-wn01 Ready  64m v1.20.4 10.65.79.131  Ubuntu 20.04.2 LTS 5.4.0-67-generic docker://20.10.5 k8s-wn02 Ready  4m16s v1.20.4 10.65.79.244  CentOS Linux 8 4.18.0-240.15.1.el8_3.centos.plus.x86_64 docker://20.10.5 Now we check if we have the containerd cli /usr/bin/ctr and the namespace moby is there. moby is the namespace from docker.\nNAME LABELS moby And we can list the running containers in this namespace\nCONTAINER IMAGE RUNTIME 04f9500885c473c9cb2b4f8d09dc4feea5c24838519b9a01251011830bab16a2 - io.containerd.runc.v2 57d4c75ab9947829228a087b857b203c48a9d1c83de0a1b49af3624fb08c9d33 - io.containerd.runc.v2 934c007a259018a5cbda56dd8e066a66f2c9cfcb8003e7f8d25833fe462582fd - io.containerd.runc.v2 94315822d8f8a05e1be5adb7e5c18add33cbf2604057100c87572b5fc55169cd - io.containerd.runc.v2 dfa01906e845239c74a0b35d457e845382468dd9ad6e99dd0c16be30f8a23a2d - io.containerd.runc.v2 If everything looks fine we can change the cri, We change one node at a time and first the worker nodes then our control node. If you have only one control node you will lose access to the cluster, this will be temporally and it should recover it self.\nCordon and Drain node We need to cordon and drain the nodes, so that are workloads are rescheduled.\nroot@k8s-cn01:~# kubectl cordon k8s-wn01 node/k8s-wn01 cordoned root@k8s-cn01:~# kubectl drain k8s-wn01 --ignore-daemonsets node/k8s-wn01 already cordoned WARNING: ignoring DaemonSet-managed Pods: kube-system/kube-proxy-9wnh4, kube-system/weave-net-pgptm evicting pod default/nginx-6799fc88d8-r44x9 pod/nginx-6799fc88d8-r44x9 evicted node/k8s-wn01 evicted root@k8s-cn01:~# kubectl get nodes NAME STATUS ROLES AGE VERSION k8s-cn01 Ready control-plane,master 138m v1.20.4 k8s-wn01 Ready,SchedulingDisabled  124m v1.20.4 k8s-wn02 Ready  64m v1.20.4 Stop services  systemctl stop kubelet systemctl stop docker Remove docker (optional) We remove Docker, this is not necessary but make things more clear, less prone for mistakes later and we will save some disk space‚Ä¶\napt purge docker-ce docker-ce-cli OR yum remove docker-ce docker-ce-cli Containerd config Disable the line disabled_plugins in /etc/containerd/config.toml so the cri interface is loaded.\n#disabled_plugins = [\"cri\"] If there is no config file for containerd, you can generate a new default file.\ncontainerd config default  /etc/containerd/config.toml The restart containerd\nsystemctl restart containerd Change runtime Edit the file /var/lib/kubelet/kubeadm-flags.env and add the containerd runtime to the flags. --container-runtime=remote and --container-runtimeendpoint=unix:///run/containerd/containerd.sock\"\nSo the kubeadm-flags file would look something like this.\nKUBELET_KUBEADM_ARGS=\"--cgroup-driver=systemd --network-plugin=cni --pod-infra-container-image=k8s.gcr.io/pause:3.2 --resolv-conf=/run/systemd/resolve/resolv.conf --container-runtime=remote --container-runtime-endpoint=unix:///run/containerd/containerd.sock\" Start kubelet After changing the runtime we can start the kubelet service.\nsystemctl start kubelet Check Now when we run kubectl get nodes -o wide and we see containerd a the runtime for the node we just changed.\nNAME STATUS ROLES AGE VERSION INTERNAL-IP EXTERNAL-IP OS-IMAGE KERNEL-VERSION CONTAINER-RUNTIME k8s-cn01 Ready\tcontrol-plane,master 131m v1.20.4 10.65.79.164  Ubuntu 20.04.2 LTS 5.4.0-67-generic docker://20.10.5 k8s-wn01 Ready,,SchedulingDisabled\t 117m v1.20.4 10.65.79.131  Ubuntu 20.04.2 LTS 5.4.0-67-generic containerd://1.4.4 k8s-wn02 Ready  57m v1.20.4 10.65.79.244  CentOS Linux 8 4.18.0-240.15.1.el8_3.centos.plus.x86_64 docker://20.10.5 The node we just changed is still cordoned. So we can uncordon it now.\nroot@k8s-cn01:~# kubectl uncordon k8s-wn01 node/k8s-wn01 uncordoned root@k8s-cn01:~# kubectl get nodes NAME STATUS ROLES AGE VERSION k8s-cn01 Ready control-plane,master 143m v1.20.4 k8s-wn01 Ready  129m v1.20.4 k8s-wn02 Ready  69m v1.20.4 If we check the namespaces on the node now, we see a new namespace, k8s.io. The moby namespace is now empty, no containers are running in this namespace all the containers are now running the the k8s.io namespace.\nroot@k8s-wn01:~# ctr namespaces list NAME LABELS k8s.io moby root@k8s-wn01:~# ctr --namespace moby container list CONTAINER IMAGE RUNTIME root@k8s-wn01:~# ctr --namespace k8s.io container list CONTAINER IMAGE RUNTIME 08d4b5ca1f0ddd08fff7f64ea4eb12be66b8ec860d119565e553c84d16942d26 docker.io/weaveworks/weave-kube:2.8.1 io.containerd.runc.v2 1c9e3f61f542b12abb4b849075b084fb7fe3f69b89ce668d73022c2cd647bcd1 k8s.gcr.io/pause:3.2 io.containerd.runc.v2 1f8e0c5a6f8219de1c8f25bbb28d5d5c71b74e9ccfb9620007701847d29f23a2 k8s.gcr.io/kube-proxy:v1.20.4 io.containerd.runc.v2 39296ebd6017a7c83cd58004c94708c927f10a996a4e6ba0bbf003c6713fe713 docker.io/weaveworks/weave-kube:2.8.1 io.containerd.runc.v2 67f812954f46fa5c1f6ab39e681e2481f868309f28bd1b8ba44cce53f5c0071c docker.io/weaveworks/weave-npc:2.8.1 io.containerd.runc.v2 9caed1d57d40cedef736e45adf550eda6a0befd32712e5b6af5d711681ba71f0 k8s.gcr.io/pause:3.2 io.containerd.runc.v2 We have changed successfully the cri, now we can move to the next node and repeat everything.\n",
  "wordCount" : "749",
  "inLanguage": "en",
  "datePublished": "2021-03-16T21:17:54Z",
  "dateModified": "2021-03-16T21:17:54Z",
  "author":{
    "@type": "Person",
    "name": "Dennis Kruyt"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://kruyt.org/post/2021/migrate-docker-containerd-kubernetes/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Dennis Kruyt",
    "logo": {
      "@type": "ImageObject",
      "url": "https://kruyt.org/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://kruyt.org/" accesskey="h" title="Dennis Kruyt (Alt + H)">Dennis Kruyt</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      Migrate from Docker to Containerd in Kubernetes
    </h1>
    <div class="post-meta"><span title='2021-03-16 21:17:54 +0000 UTC'>March 16, 2021</span>&nbsp;¬∑&nbsp;Dennis Kruyt

</div>
  </header> 
  <div class="post-content"><p>Kubernetes is <a href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.20.md#deprecation">deprecating Docker</a> as a container runtime after v1.20. Don&rsquo;t Panic üò± Docker containers are still supported, but the dockershim/Docker, the layer between Kubernetes and containerd  is deprecated and will be removed from version 1.22+.</p>
<figure class="kg-card kg-bookmark-card">
  <a href="https://kubernetes.io/blog/2020/12/02/dont-panic-kubernetes-and-docker/" class="kg-bookmark-container">
    <div class="kg-bookmark-content">
      <div class="kg-bookmark-title">Don‚Äôt Panic: Kubernetes and Docker</div>
      <div class="kg-bookmark-description">Authors: Jorge Castro, Duffie Cooley, Kat Cosgrove, Justin Garrison, Noah Kantrowitz, Bob Killen, Rey Lejano, Dan ‚ÄúPOP‚Äù Papandrea, Jeffrey Sica, Davanum ‚ÄúDims‚Äù Srinivas\nKubernetes is deprecating Docker as a container runtime after v1.20.\nYou do not need to panic. It‚Äôs not as dramatic as it sounds.\nT‚Ä¶</div>
      <div class="kg-bookmark-metadata">
        <img src="https://kubernetes.io/favicons/apple-touch-icon-180x180.png" class="kg-bookmark-icon">
        <span class="kg-bookmark-author">Wednesday, December 02, 2020</span>
        <span class="kg-bookmark-publisher">Kubernetes</span>
      </div>
    </div>
    
    <div class="kg-bookmark-thumbnail">
      <img src="https://kubernetes.io/images/favicon.png">
    </div>
    
  </a>
  
</figure>
<p>So if you are running docker you need to change to a supported container runtime interface (CRI). containerd is a good choice, it is already running on your Kubernetes node if you are running Docker.</p>
<p>An extra advantage is there is less overhead, there is no docker-shim and Docker translation layers as  you can see is this diagram.</p>
<figure>
    <img loading="lazy" src="/images/2021/03/docker_containerd.png"
         alt="change from docker shim to containerd CRI"/> <figcaption>
            <p>change from docker shim to containerd CRI</p>
        </figcaption>
</figure>

<h2 id="how-to-migrate">How to migrate<a hidden class="anchor" aria-hidden="true" href="#how-to-migrate">#</a></h2>
<p>First we check what container runtime is currently running. We do this with <code>kubectl get nodes -o wide</code></p>
<p>As we can see we are runnig Docker as runtime.</p>
<pre tabindex="0"><code>NAME       STATUS   ROLES                  AGE     VERSION   INTERNAL-IP    EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION                             CONTAINER-RUNTIME
k8s-cn01   Ready    control-plane,master   78m     v1.20.4   10.65.79.164   &lt;none&gt;        Ubuntu 20.04.2 LTS   5.4.0-67-generic                           docker://20.10.5
k8s-wn01   Ready    &lt;none&gt;                 64m     v1.20.4   10.65.79.131   &lt;none&gt;        Ubuntu 20.04.2 LTS   5.4.0-67-generic                           docker://20.10.5
k8s-wn02   Ready    &lt;none&gt;                 4m16s   v1.20.4   10.65.79.244   &lt;none&gt;        CentOS Linux 8       4.18.0-240.15.1.el8_3.centos.plus.x86_64   docker://20.10.5
</code></pre><p>Now we check if we have the containerd cli <code>/usr/bin/ctr</code> and the namespace <em>moby</em> is there. <em>moby</em> is the namespace from docker.</p>
<pre tabindex="0"><code>NAME LABELS
moby
</code></pre><p>And we can list the running containers in this namespace</p>
<pre tabindex="0"><code>CONTAINER                                                           IMAGE    RUNTIME
04f9500885c473c9cb2b4f8d09dc4feea5c24838519b9a01251011830bab16a2    -        io.containerd.runc.v2
57d4c75ab9947829228a087b857b203c48a9d1c83de0a1b49af3624fb08c9d33    -        io.containerd.runc.v2
934c007a259018a5cbda56dd8e066a66f2c9cfcb8003e7f8d25833fe462582fd    -        io.containerd.runc.v2
94315822d8f8a05e1be5adb7e5c18add33cbf2604057100c87572b5fc55169cd    -        io.containerd.runc.v2
dfa01906e845239c74a0b35d457e845382468dd9ad6e99dd0c16be30f8a23a2d    -        io.containerd.runc.v2
</code></pre><p>If everything looks fine we can change the cri, We change one node at a time and first the worker nodes then our control node. If you have only one control node you will lose access to the cluster, this will be temporally and it should recover it self.</p>
<h3 id="cordon-and-drain-node">Cordon and Drain node<a hidden class="anchor" aria-hidden="true" href="#cordon-and-drain-node">#</a></h3>
<p>We need to cordon and drain the nodes, so that are workloads are rescheduled.</p>
<pre tabindex="0"><code>root@k8s-cn01:~# kubectl cordon k8s-wn01
node/k8s-wn01 cordoned

root@k8s-cn01:~# kubectl drain k8s-wn01 --ignore-daemonsets
node/k8s-wn01 already cordoned
WARNING: ignoring DaemonSet-managed Pods: kube-system/kube-proxy-9wnh4, kube-system/weave-net-pgptm
evicting pod default/nginx-6799fc88d8-r44x9
pod/nginx-6799fc88d8-r44x9 evicted
node/k8s-wn01 evicted

root@k8s-cn01:~# kubectl get nodes
NAME       STATUS                     ROLES                  AGE    VERSION
k8s-cn01   Ready                      control-plane,master   138m   v1.20.4
k8s-wn01   Ready,SchedulingDisabled   &lt;none&gt;                 124m   v1.20.4
k8s-wn02   Ready                      &lt;none&gt;                 64m    v1.20.4
</code></pre><h3 id="stop-services">Stop services<a hidden class="anchor" aria-hidden="true" href="#stop-services">#</a></h3>
<pre tabindex="0"><code>  systemctl stop kubelet
  systemctl stop docker
</code></pre><h3 id="remove-docker-optional">Remove docker (optional)<a hidden class="anchor" aria-hidden="true" href="#remove-docker-optional">#</a></h3>
<p>We remove Docker, this is not necessary but make things more clear, less prone for mistakes later and we will save some disk space&hellip;</p>
<pre tabindex="0"><code>apt purge docker-ce docker-ce-cli
OR
yum remove docker-ce docker-ce-cli
</code></pre><h3 id="containerd-config">Containerd config<a hidden class="anchor" aria-hidden="true" href="#containerd-config">#</a></h3>
<p>Disable the line disabled_plugins in <code>/etc/containerd/config.toml</code> so the cri interface is loaded.</p>
<pre tabindex="0"><code>#disabled_plugins = [&quot;cri&quot;]
</code></pre><p>If there is <strong>no config</strong> file for containerd, you can generate a new default file.</p>
<pre tabindex="0"><code>containerd config default &gt; /etc/containerd/config.toml
</code></pre><p>The restart containerd</p>
<pre tabindex="0"><code>systemctl restart containerd
</code></pre><h3 id="change-runtime">Change runtime<a hidden class="anchor" aria-hidden="true" href="#change-runtime">#</a></h3>
<p>Edit the file <code>/var/lib/kubelet/kubeadm-flags.env</code> and add the containerd runtime to the flags. <code>--container-runtime=remote</code> and <code>--container-runtimeendpoint=unix:///run/containerd/containerd.sock&quot;</code></p>
<p>So the kubeadm-flags file would look something like this.</p>
<pre tabindex="0"><code>KUBELET_KUBEADM_ARGS=&quot;--cgroup-driver=systemd --network-plugin=cni --pod-infra-container-image=k8s.gcr.io/pause:3.2
--resolv-conf=/run/systemd/resolve/resolv.conf --container-runtime=remote --container-runtime-endpoint=unix:///run/containerd/containerd.sock&quot;
</code></pre><h3 id="start-kubelet">Start kubelet<a hidden class="anchor" aria-hidden="true" href="#start-kubelet">#</a></h3>
<p>After changing the runtime we can start the kubelet service.</p>
<pre tabindex="0"><code>systemctl start kubelet
</code></pre><h3 id="check">Check<a hidden class="anchor" aria-hidden="true" href="#check">#</a></h3>
<p>Now when we run <code>kubectl get nodes -o wide</code> and we see containerd a the runtime for the node we just changed.</p>
<pre tabindex="0"><code>NAME       STATUS  		 			ROLES                  AGE    VERSION   INTERNAL-IP    EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION                             CONTAINER-RUNTIME
k8s-cn01   Ready	 		    	control-plane,master   131m   v1.20.4   10.65.79.164   &lt;none&gt;        Ubuntu 20.04.2 LTS   5.4.0-67-generic                           docker://20.10.5
k8s-wn01   Ready,,SchedulingDisabled	    &lt;none&gt;                 117m   v1.20.4   10.65.79.131  		 &lt;none&gt;        Ubuntu 20.04.2 LTS   5.4.0-67-generic                           containerd://1.4.4
k8s-wn02   Ready   			 &lt;none&gt;                 57m    v1.20.4   10.65.79.244   &lt;none&gt;        CentOS Linux 8       4.18.0-240.15.1.el8_3.centos.plus.x86_64   docker://20.10.5
</code></pre><p>The node we just changed is still cordoned. So we can uncordon it now.</p>
<pre tabindex="0"><code>root@k8s-cn01:~# kubectl uncordon k8s-wn01
node/k8s-wn01 uncordoned

root@k8s-cn01:~# kubectl get nodes
NAME       STATUS   ROLES                  AGE    VERSION
k8s-cn01   Ready    control-plane,master   143m   v1.20.4
k8s-wn01   Ready    &lt;none&gt;                 129m   v1.20.4
k8s-wn02   Ready    &lt;none&gt;                 69m    v1.20.4
</code></pre><p>If we check the namespaces on the node now, we see a new namespace, <em>k8s.io</em>. The <em>moby</em> namespace is now empty, no containers are running in this namespace all the containers are now running the the k8s.io namespace.</p>
<pre tabindex="0"><code>root@k8s-wn01:~# ctr namespaces list
NAME   LABELS
k8s.io
moby

root@k8s-wn01:~# ctr --namespace moby container list
CONTAINER    IMAGE    RUNTIME

root@k8s-wn01:~# ctr --namespace k8s.io container list
CONTAINER                                                           IMAGE                                    RUNTIME
08d4b5ca1f0ddd08fff7f64ea4eb12be66b8ec860d119565e553c84d16942d26    docker.io/weaveworks/weave-kube:2.8.1    io.containerd.runc.v2
1c9e3f61f542b12abb4b849075b084fb7fe3f69b89ce668d73022c2cd647bcd1    k8s.gcr.io/pause:3.2                     io.containerd.runc.v2
1f8e0c5a6f8219de1c8f25bbb28d5d5c71b74e9ccfb9620007701847d29f23a2    k8s.gcr.io/kube-proxy:v1.20.4            io.containerd.runc.v2
39296ebd6017a7c83cd58004c94708c927f10a996a4e6ba0bbf003c6713fe713    docker.io/weaveworks/weave-kube:2.8.1    io.containerd.runc.v2
67f812954f46fa5c1f6ab39e681e2481f868309f28bd1b8ba44cce53f5c0071c    docker.io/weaveworks/weave-npc:2.8.1     io.containerd.runc.v2
9caed1d57d40cedef736e45adf550eda6a0befd32712e5b6af5d711681ba71f0    k8s.gcr.io/pause:3.2                     io.containerd.runc.v2
</code></pre><p>We have changed successfully the cri, now we can move to the next node and repeat everything.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://kruyt.org/tags/kubernetes/">kubernetes</a></li>
      <li><a href="https://kruyt.org/tags/kubelet/">kubelet</a></li>
      <li><a href="https://kruyt.org/tags/containerd/">containerd</a></li>
      <li><a href="https://kruyt.org/tags/deprecated/">deprecated</a></li>
      <li><a href="https://kruyt.org/tags/docker/">docker</a></li>
      <li><a href="https://kruyt.org/tags/dockershim/">dockershim</a></li>
      <li><a href="https://kruyt.org/tags/1.22/">1.22</a></li>
      <li><a href="https://kruyt.org/tags/cri/">cri</a></li>
      <li><a href="https://kruyt.org/tags/migrate/">migrate</a></li>
      <li><a href="https://kruyt.org/tags/1.20/">1.20</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2021 <a href="https://kruyt.org/">Dennis Kruyt</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
