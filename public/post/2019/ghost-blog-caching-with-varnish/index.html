<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Ghost blog caching with Varnish | Dennis Kruyt</title>
<meta name="keywords" content="ghost, purge, cache, caching, varnish" />
<meta name="description" content="In this post I show a few of my tip&rsquo;s for using Varnish for caching and Ghost together.
Don&rsquo;t cache everything Caching is good, but we don&rsquo;t want to cache everything in ghost, we don&rsquo;t want to cache the admin and preview pages in ghost. Add the following in the sub vcl_recv part.
# Did not cache the admin and preview pages if (req.url ~ &#34;/(admin|p|ghost)/&#34;) { return (pass); } restart Varnish to activate the changes.">
<meta name="author" content="Dennis Kruyt">
<link rel="canonical" href="https://kruyt.org/post/2019/ghost-blog-caching-with-varnish/" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.c88963fe2d79462000fd0fb1b3737783c32855d340583e4523343f8735c787f0.css" integrity="sha256-yIlj/i15RiAA/Q&#43;xs3N3g8MoVdNAWD5FIzQ/hzXHh/A=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js" integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5&#43;kdJvBz5iKbt6B5PJI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://kruyt.org/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://kruyt.org/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://kruyt.org/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://kruyt.org/apple-touch-icon.png">
<link rel="mask-icon" href="https://kruyt.org/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<meta name="generator" content="Hugo 0.89.4" />
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Ghost blog caching with Varnish" />
<meta property="og:description" content="In this post I show a few of my tip&rsquo;s for using Varnish for caching and Ghost together.
Don&rsquo;t cache everything Caching is good, but we don&rsquo;t want to cache everything in ghost, we don&rsquo;t want to cache the admin and preview pages in ghost. Add the following in the sub vcl_recv part.
# Did not cache the admin and preview pages if (req.url ~ &#34;/(admin|p|ghost)/&#34;) { return (pass); } restart Varnish to activate the changes." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://kruyt.org/post/2019/ghost-blog-caching-with-varnish/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2019-10-06T19:13:15&#43;00:00" />
<meta property="article:modified_time" content="2019-10-06T19:13:15&#43;00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Ghost blog caching with Varnish"/>
<meta name="twitter:description" content="In this post I show a few of my tip&rsquo;s for using Varnish for caching and Ghost together.
Don&rsquo;t cache everything Caching is good, but we don&rsquo;t want to cache everything in ghost, we don&rsquo;t want to cache the admin and preview pages in ghost. Add the following in the sub vcl_recv part.
# Did not cache the admin and preview pages if (req.url ~ &#34;/(admin|p|ghost)/&#34;) { return (pass); } restart Varnish to activate the changes."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://kruyt.org/post/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Ghost blog caching with Varnish",
      "item": "https://kruyt.org/post/2019/ghost-blog-caching-with-varnish/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Ghost blog caching with Varnish",
  "name": "Ghost blog caching with Varnish",
  "description": "In this post I show a few of my tip\u0026rsquo;s for using Varnish for caching and Ghost together.\nDon\u0026rsquo;t cache everything Caching is good, but we don\u0026rsquo;t want to cache everything in ghost, we don\u0026rsquo;t want to cache the admin and preview pages in ghost. Add the following in the sub vcl_recv part.\n# Did not cache the admin and preview pages if (req.url ~ \u0026#34;/(admin|p|ghost)/\u0026#34;) { return (pass); } restart Varnish to activate the changes.",
  "keywords": [
    "ghost", "purge", "cache", "caching", "varnish"
  ],
  "articleBody": "In this post I show a few of my tip’s for using Varnish for caching and Ghost together.\nDon’t cache everything Caching is good, but we don’t want to cache everything in ghost, we don’t want to cache the admin and preview pages in ghost. Add the following in the sub vcl_recv part.\n# Did not cache the admin and preview pages if (req.url ~ \"/(admin|p|ghost)/\") { return (pass); } restart Varnish to activate the changes.\nAuto clear cache after a new or modified ghost blog post When we modify or create a new post in ghost, changes are not immediately available. Because the pages are being cached and Varnish has no knowledge of a new page. This will wait until the cache is expired to retrieve new pages. We can set a short ttl in Varnish, but a better solution is that ghost will notify Varnish to clear the cache.\nAdd an ACL in the Varnish config, these ip’s are then allow to clear the cache via an URL.\nacl purge { \"yourghostserver.com\"; \"10.58.33.224\"; } Add in the sub vcl_recv in the varnish config the following. This will create a url when called that will clear the cache for the matching http host. Change the myblog.com to your site name.\nif (req.url ~ \"/clearcache/myblog\") { # Same ACL check as above: if (!client.ip ~ purge) { return(synth(403, \"Not allowed.\")); } ban(\"req.http.host == myblog.com\"); # Throw a synthetic page so the # request won't go to the backend. return(synth(200, \"Cache cleared\")); } After these changed you need to restart Varnish. And you can test it with curl.\nroot@revproxy01:/etc/varnish# curl -s -v http://10.68.33.237:6081/clearcache/myblog * Trying 10.68.33.237... * TCP_NODELAY set * Connected to localhost (10.68.33.237) port 6081 (#0)  GET /clearcache/myblog HTTP/1.1  Host: 10.68.33.237:6081  User-Agent: curl/7.58.0  Accept: */*    200 Cache cleared   Error 200 Cache cleared Cache cleared\nGuru Meditation: XID: 983101\n Varnish cache server\n  And we can test if it really clears the cache by checking the http headers from Varnish.\nroot@revproxy01:/etc/varnish# curl -s -v --output /dev/null https://myblog.com/assets/styles/main.css 2\u00261 |egrep \"(age:|hit)\" \u00261 |egrep \"(age:|hit)\" Now we have setup Varnish with a url to clear the cache. Next is that we are going to automate this from ghost. because we don’t want to manually do this every time we post or modify a post in ghost.\nTo do this we need to setup a webhook in the ghost admin page.\nGo to integrations in the ghost admin menu and a custom integration. Give it a name. for example clear cache.\nThen click configure and click add webhook. And fill in the name, event and target url (your varnish serser)\n  Don’t forget to press also save at the top of the page.\nAfter this every site change wil clear the varnish cache automatically and your new content is immediately available. You can also see when the trigger was last triggered in ghost.\n  ",
  "wordCount" : "552",
  "inLanguage": "en",
  "datePublished": "2019-10-06T19:13:15Z",
  "dateModified": "2019-10-06T19:13:15Z",
  "author":{
    "@type": "Person",
    "name": "Dennis Kruyt"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://kruyt.org/post/2019/ghost-blog-caching-with-varnish/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Dennis Kruyt",
    "logo": {
      "@type": "ImageObject",
      "url": "https://kruyt.org/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://kruyt.org/" accesskey="h" title="Dennis Kruyt (Alt + H)">Dennis Kruyt</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      Ghost blog caching with Varnish
    </h1>
    <div class="post-meta"><span title='2019-10-06 19:13:15 +0000 UTC'>October 6, 2019</span>&nbsp;·&nbsp;Dennis Kruyt

</div>
  </header> 
  <div class="post-content"><p>In this post I show a few of my tip&rsquo;s for using Varnish for caching and Ghost together.</p>
<h3 id="dont-cache-everything">Don&rsquo;t cache everything<a hidden class="anchor" aria-hidden="true" href="#dont-cache-everything">#</a></h3>
<p>Caching is good, but we don&rsquo;t want to cache everything in ghost, we don&rsquo;t want to cache the admin and preview pages in ghost. Add the following in the <strong>sub vcl_recv</strong> part.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">  <span style="color:#75715e"># Did not cache the admin and preview pages</span>
 <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>req.url ~ <span style="color:#e6db74">&#34;/(admin|p|ghost)/&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
           <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>pass<span style="color:#f92672">)</span>;
  <span style="color:#f92672">}</span>
</code></pre></div><p>restart Varnish to activate the changes.</p>
<h3 id="auto-clear-cache-after-a-new-or-modified-ghost-blog-post">Auto clear cache after a new or modified ghost blog post<a hidden class="anchor" aria-hidden="true" href="#auto-clear-cache-after-a-new-or-modified-ghost-blog-post">#</a></h3>
<p>When we modify or create a new post in ghost, changes are not immediately available. Because the pages are being cached and Varnish has no knowledge of a new page. This will wait until the cache is expired to retrieve new pages. We can set a short ttl in Varnish, but a better solution is that ghost will notify Varnish to clear the cache.</p>
<p>Add an ACL in the Varnish config, these ip&rsquo;s are then allow to clear the cache via an URL.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">acl purge <span style="color:#f92672">{</span>
    <span style="color:#e6db74">&#34;yourghostserver.com&#34;</span>;
    <span style="color:#e6db74">&#34;10.58.33.224&#34;</span>;
<span style="color:#f92672">}</span>

</code></pre></div><p>Add in the <strong>sub vcl_recv</strong> in the varnish config the following. This will create a url when called that will clear the cache for the matching http host. Change the <em>myblog.com</em> to your site name.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>req.url ~ <span style="color:#e6db74">&#34;/clearcache/myblog&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>

          <span style="color:#75715e"># Same ACL check as above:</span>
          <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>!client.ip ~ purge<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                   <span style="color:#66d9ef">return</span><span style="color:#f92672">(</span>synth<span style="color:#f92672">(</span>403, <span style="color:#e6db74">&#34;Not allowed.&#34;</span><span style="color:#f92672">))</span>;
          <span style="color:#f92672">}</span>
          ban<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;req.http.host == myblog.com&#34;</span><span style="color:#f92672">)</span>;

          <span style="color:#75715e"># Throw a synthetic page so the</span>
          <span style="color:#75715e"># request won&#39;t go to the backend.</span>
          <span style="color:#66d9ef">return</span><span style="color:#f92672">(</span>synth<span style="color:#f92672">(</span>200, <span style="color:#e6db74">&#34;Cache cleared&#34;</span><span style="color:#f92672">))</span>;
  <span style="color:#f92672">}</span>
</code></pre></div><p>After these changed you need to restart Varnish. And you can test it with curl.</p>
<pre tabindex="0"><code>root@revproxy01:/etc/varnish# curl -s -v http://10.68.33.237:6081/clearcache/myblog
*   Trying 10.68.33.237...
* TCP_NODELAY set
* Connected to localhost (10.68.33.237) port 6081 (#0)
&gt; GET /clearcache/myblog HTTP/1.1
&gt; Host: 10.68.33.237:6081
&gt; User-Agent: curl/7.58.0
&gt; Accept: */*
&gt;
&lt; HTTP/1.1 200 Cache cleared
&lt; Date: Sun, 06 Oct 2019 20:31:28 GMT
&lt; Server: Varnish
&lt; X-Varnish: 983101
&lt; Content-Type: text/html; charset=utf-8
&lt; Retry-After: 5
&lt; Content-Length: 316
&lt; Accept-Ranges: bytes
&lt; Connection: keep-alive
&lt;
&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;200 Cache cleared&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;h1&gt;Error 200 Cache cleared&lt;/h1&gt;
    &lt;p&gt;Cache cleared&lt;/p&gt;
    &lt;h3&gt;Guru Meditation:&lt;/h3&gt;
    &lt;p&gt;XID: 983101&lt;/p&gt;
    &lt;hr&gt;
    &lt;p&gt;Varnish cache server&lt;/p&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre><p>And we can test if it really clears the cache by checking the http headers from Varnish.</p>
<pre tabindex="0"><code>root@revproxy01:/etc/varnish# curl -s -v --output /dev/null https://myblog.com/assets/styles/main.css 2&gt;&amp;1 |egrep &quot;(age:|hit)&quot;
&lt; age: 92
&lt; x-cache-hits: 11
root@revproxy01:/etc/varnish# curl -s --output /dev/null http://10.68.33.237:6081/clearcache/myblog
root@revproxy01:/etc/varnish# curl -s -v --output /dev/null https://myblog.com/assets/styles/main.css 2&gt;&amp;1 |egrep &quot;(age:|hit)&quot;
&lt; age: 0
&lt; x-cache-hits: 0
</code></pre><p>Now we have setup Varnish with a url to clear the cache. Next is that we are going to automate this from ghost. because we don&rsquo;t want to manually do this every time we post or modify a post in ghost.</p>
<p>To do this we need to setup a webhook in the ghost admin page.</p>
<p>Go to integrations in the ghost admin menu and a custom integration. Give it a name. for example <em>clear cache.</em></p>
<p>Then click configure and click add webhook. And fill in the name, event and target url (your varnish serser)</p>
<figure>
    <img loading="lazy" src="/images/2019/10/image-2.png"/> 
</figure>

<p>Don&rsquo;t forget to press also save at the top of the page.</p>
<p>After this every site change wil clear the varnish cache automatically and your new content is immediately available. You can also see when the trigger was last triggered in ghost.</p>
<figure>
    <img loading="lazy" src="/images/2019/10/image-1.png"/> 
</figure>



  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://kruyt.org/tags/ghost/">ghost</a></li>
      <li><a href="https://kruyt.org/tags/purge/">purge</a></li>
      <li><a href="https://kruyt.org/tags/cache/">cache</a></li>
      <li><a href="https://kruyt.org/tags/caching/">caching</a></li>
      <li><a href="https://kruyt.org/tags/varnish/">varnish</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2021 <a href="https://kruyt.org/">Dennis Kruyt</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
