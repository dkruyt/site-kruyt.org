<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Ansible CICD pipeline with GitLab | Dennis Kruyt</title>
<meta name="keywords" content="ansible, cicd, pipeline, flow, git, merge, cd, gitlab, ci" />
<meta name="description" content="In this post I will show how I use GitLab CICD with Ansible. I&rsquo;ll show the pipelines and how the merge requests are handled for full control and auditing.
GitLab flow The GitLab flow is as following, you have one or more dev/working branches. To push code to the staging environment you do this via an merge request in GitLab, en to get this code in to production. Again via a merge request from the master branch to the production branch.">
<meta name="author" content="Dennis Kruyt">
<link rel="canonical" href="https://kruyt.org/ansible-ci-with-gitlab/" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.c88963fe2d79462000fd0fb1b3737783c32855d340583e4523343f8735c787f0.css" integrity="sha256-yIlj/i15RiAA/Q&#43;xs3N3g8MoVdNAWD5FIzQ/hzXHh/A=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js" integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5&#43;kdJvBz5iKbt6B5PJI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://kruyt.org/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://kruyt.org/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://kruyt.org/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://kruyt.org/apple-touch-icon.png">
<link rel="mask-icon" href="https://kruyt.org/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<meta name="generator" content="Hugo 0.89.4" />
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Ansible CICD pipeline with GitLab" />
<meta property="og:description" content="In this post I will show how I use GitLab CICD with Ansible. I&rsquo;ll show the pipelines and how the merge requests are handled for full control and auditing.
GitLab flow The GitLab flow is as following, you have one or more dev/working branches. To push code to the staging environment you do this via an merge request in GitLab, en to get this code in to production. Again via a merge request from the master branch to the production branch." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://kruyt.org/ansible-ci-with-gitlab/" />
<meta property="og:image" content="https://kruyt.org/images/2020/10/photo-1567789884554-0b844b597180.jpeg" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2020-01-17T11:44:48&#43;00:00" />
<meta property="article:modified_time" content="2020-01-17T11:44:48&#43;00:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://kruyt.org/images/2020/10/photo-1567789884554-0b844b597180.jpeg" />
<meta name="twitter:title" content="Ansible CICD pipeline with GitLab"/>
<meta name="twitter:description" content="In this post I will show how I use GitLab CICD with Ansible. I&rsquo;ll show the pipelines and how the merge requests are handled for full control and auditing.
GitLab flow The GitLab flow is as following, you have one or more dev/working branches. To push code to the staging environment you do this via an merge request in GitLab, en to get this code in to production. Again via a merge request from the master branch to the production branch."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://kruyt.org/post/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Ansible CICD pipeline with GitLab",
      "item": "https://kruyt.org/ansible-ci-with-gitlab/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Ansible CICD pipeline with GitLab",
  "name": "Ansible CICD pipeline with GitLab",
  "description": "In this post I will show how I use GitLab CICD with Ansible. I\u0026rsquo;ll show the pipelines and how the merge requests are handled for full control and auditing.\nGitLab flow The GitLab flow is as following, you have one or more dev/working branches. To push code to the staging environment you do this via an merge request in GitLab, en to get this code in to production. Again via a merge request from the master branch to the production branch.",
  "keywords": [
    "ansible", "cicd", "pipeline", "flow", "git", "merge", "cd", "gitlab", "ci"
  ],
  "articleBody": "In this post I will show how I use GitLab CICD with Ansible. I’ll show the pipelines and how the merge requests are handled for full control and auditing.\nGitLab flow The GitLab flow is as following, you have one or more dev/working branches. To push code to the staging environment you do this via an merge request in GitLab, en to get this code in to production. Again via a merge request from the master branch to the production branch. This way we have automation but also control and auditing via merge request.\n  Ansible GitLab flow\n  This can be be adjusted to suit environments and policies you need. It will not matter if you have a test and acceptance environment, or use tags, the principle will be the same.\nGitLab CICD Pipeline To use GitLab’s CICD pipeline we need to create a .gitlab-ci.yml file, this is the heart of CI in GitLab.\n  CICD pipeline overview\n  Below a breakdown of of this yaml file. On my system it will spin up a Kubernetes Ubuntu pod, in this pod the verify test will run and the Ansible playbooks will be runned. But it should also work on a Gitlab runner with Docker.\nbefore_script First we need a before_script which will be executed by the GitLab runner at the start. We will use a local Docker image that has the environment for Ansible. This already has installed python, ansible and ansible-lint. Also we will put the private SSH key here. This key is defined as a variable in GitLab so this key is not in the git repository.\ncover: image: localhost:5000/ubuntu_ansible before_script: - whoami - apt-get update -qy #update system - git submodule update --init - ansible --version - ansible-lint --version - mkdir secret # create secret dir - echo \"$ANSIBLE_SSHKEY\"  secret/ansible.key # create priv key from gitlab variable - chmod 400 secret/ansible.key - export ANSIBLE_HOST_KEY_CHECKING=False # disable host key checking for ansible #Download base image ubuntu 18.04 FROM ubuntu:18.04 # Update Ubuntu Software repository RUN apt-get -qy update RUN apt install -qy python software-properties-common git RUN apt-add-repository --yes --update ppa:ansible/ansible RUN apt install -qy ansible ansible-lint CMD [\"/bin/bash\"] Stages We have defined a couple of stages we want to run on certain events in GitLab.\nstages: - verify - prestaging - staging - predeploy - deploy Verify commit For each commit into GitLab there will be a verify pipeline running. That will do an ansible-lint and a ansible-playbook –check. This is to make sure that the code is syntax error free.\n#verify syntaxs etc... ansible-verify: stage: verify script: - ansible-lint -v *.yml - ansible-playbook --inventory inventory/production --syntax-check *.yml rules: - if: '$CI_BUILD_BEFORE_SHA == \"0000000000000000000000000000000000000000\"' when: always - if: '$CI_COMMIT_BRANCH != \"master\" \u0026\u0026 $CI_COMMIT_BRANCH != \"production\"' when: always   commit to work branch, pass the verify pipeline\n  Merge request to master (staging) When you need to push code to the staging environment you do this via a merge request to master. Then again will the verify stage be runned, but also there wil be a pre-staging and staging pipe be runned. The pre-staging pipeline will do an Ansible ping. To make sure all hosts are up and working for Ansible. If this fails the pipeline will be cancelled. If the staging hosts are ok, the the Ansible playbook will be runned and the code will be commit to master.\n  Create a merge request from work-branch to master (staging)\n  We can tick the option to automatically merge to master when the pipeline succeeds.\n  running staging pipeline\n  The yaml code that will check is staging hosts are online and working via Ansible ping. If they are execute the playbook, on success merge to master.\n# make sure all staging hosts are online and can be manged by ansible if not stop pipeline prestaging: stage: prestaging script: - ansible --private-key secret/ansible.key --user ansible --inventory inventory/staging all -m ping rules: - if: '$CI_MERGE_REQUEST_TARGET_BRANCH_NAME == \"master\"' when: always # test playbook on staging envirioment only run on merge requests to master staging: stage: staging script: - ./cicd-info.sh  roles/common/files/cicd-info.txt # Run script to get GitLab CI env vars. Ansible will copy then to hosts. - ansible-playbook --private-key secret/ansible.key --user ansible --inventory inventory/staging common.yml rules: - if: '$CI_MERGE_REQUEST_TARGET_BRANCH_NAME == \"master\"' when: always   merge to master (staging) pipeline\n  Merge request to production from master (staging) To deploy to production will also happen via a merge request. It is the same principle as from work-brand to master. The only difference is that Ansible will use production hosts.\n# make sure all production hosts are online and can be manged by ansible if not stop pipeline predeploy: stage: predeploy script: - ansible --private-key secret/ansible.key --user ansible --inventory inventory/production all -m ping rules: - if: '$CI_MERGE_REQUEST_TARGET_BRANCH_NAME == \"production\"' when: always # deploy playbooks to production deploy: stage: deploy script: - ./cicd-info.sh  roles/common/files/cicd-info.txt # Run script to get GitLab CI env vars. Ansible will copy then to hosts. - ansible-playbook --private-key secret/ansible.key --user ansible --inventory inventory/production common.yml rules: - if: '$CI_MERGE_REQUEST_TARGET_BRANCH_NAME == \"production\"' when: always   merge to production pipeline\n  Job overview Here we see all jobs that are involved from the commit in the work-branch al the way to production. These jobs are lint and syntax checked, have passed staging and have been successful deployed on production.\n  job overview\n  cicd-info.sh I also created a small script, that will gather some usefull GitLab CI envirioment varibles on the runner. This script will put these in a file and Ansible will pick this file up and put the on the hosts.\n#!/bin/bash  echo \"Gitlab CICD Ansible run info\" echo echo \"started on `date`\" echo \"Project name: $CI_PROJECT_NAME\" echo \"Commit SHA: $CI_COMMIT_SHORT_SHA\" echo \"On runner: $HOSTNAMEwith ID: $CI_RUNNER_ID\" echo \"Job info url: $CI_JOB_URL\" echo \"By user: $GITLAB_USER_LOGIN$GITLAB_USER_EMAIL\" echo \"Commit: $CI_COMMIT_TITLE\" --- - name: Copy GitLab cicd envirioment run to host copy: src: cicd-info.txt dest: /etc/cicd-info.txt owner: root group: root mode: '0755' The output on the hosts will look something like this. With these info we can always look at the latest Ansible run for this host in GitLab.\n0 dennis@ragnarok:~ cat /etc/cicd-info.txt Gitlab CICD Ansible run info started on Wed Jan 15 14:09:34 UTC 2020 Project name: ansible Commit SHA: ed2cc1b0 On runner: runner-bhpg76e-project-2-concurrent-0dgklh with ID: 2 Job info url: http://192.168.66.148/dkruyt/ansible/-/jobs/192 By user: dkruyt  Commit: Merge branch 'work-branch' into 'master' Protect master and production branch Make sure your master and production branch are protected, so no one can commit directly in to these branches. Because we want to run the correct pipelines on merge requests.\n  protect your branches\n  ",
  "wordCount" : "1084",
  "inLanguage": "en",
  "image":"https://kruyt.org/images/2020/10/photo-1567789884554-0b844b597180.jpeg","datePublished": "2020-01-17T11:44:48Z",
  "dateModified": "2020-01-17T11:44:48Z",
  "author":{
    "@type": "Person",
    "name": "Dennis Kruyt"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://kruyt.org/ansible-ci-with-gitlab/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Dennis Kruyt",
    "logo": {
      "@type": "ImageObject",
      "url": "https://kruyt.org/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://kruyt.org/" accesskey="h" title="Dennis Kruyt (Alt + H)">Dennis Kruyt</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      Ansible CICD pipeline with GitLab
    </h1>
    <div class="post-meta"><span title='2020-01-17 11:44:48 +0000 UTC'>January 17, 2020</span>&nbsp;·&nbsp;Dennis Kruyt

</div>
  </header> 
<figure class="entry-cover"><img loading="lazy" src="https://kruyt.org/images/2020/10/photo-1567789884554-0b844b597180.jpeg" alt="">
        
</figure>
  <div class="post-content"><p>In this post I will show how I use GitLab CICD with Ansible. I&rsquo;ll show the pipelines and how the merge requests are handled for full control and auditing.</p>
<h2 id="gitlab-flow">GitLab flow<a hidden class="anchor" aria-hidden="true" href="#gitlab-flow">#</a></h2>
<p>The GitLab flow is as following, you have one or more dev/working branches. To push code to the staging environment you do this via an merge request in GitLab, en to get this code in to production. Again via a merge request from the master branch to the production branch. This way we have automation but also control and auditing via merge request.</p>
<figure>
    <img loading="lazy" src="/images/2020/01/ansibleflow.png"
         alt="Ansible GitLab flow"/> <figcaption>
            <p>Ansible GitLab flow</p>
        </figcaption>
</figure>

<p>This can be be adjusted to suit environments and policies you need.  It will not matter if you have a test and acceptance environment, or use tags, the principle will be the same.</p>
<h2 id="gitlab-cicd-pipeline">GitLab CICD Pipeline<a hidden class="anchor" aria-hidden="true" href="#gitlab-cicd-pipeline">#</a></h2>
<p>To use GitLab&rsquo;s CICD pipeline we need to create a <em>.gitlab-ci.yml</em> file, this is the heart of CI in GitLab.</p>
<figure>
    <img loading="lazy" src="/images/2020/01/cicd_pipeline_infograph.png"
         alt="CICD pipeline overview"/> <figcaption>
            <p>CICD pipeline overview</p>
        </figcaption>
</figure>

<p>Below a breakdown of of this <em>yaml</em> file. On my system it will spin up a Kubernetes Ubuntu pod, in this pod the verify test will run and the Ansible playbooks will be runned. But it should also work on a Gitlab runner with Docker.</p>
<h3 id="before_script">before_script<a hidden class="anchor" aria-hidden="true" href="#before_script">#</a></h3>
<p>First we need a <em>before_script</em> which will be executed by the GitLab runner at the start. We will use a local Docker image that has the environment for Ansible. This already has installed <em>python,</em>  <em>ansible</em> and <em>ansible-lint</em>. Also we will put the private SSH key here. This key is defined as a variable in GitLab so this key is <strong>not</strong> in the git repository.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">cover</span>:
  <span style="color:#f92672">image</span>: <span style="color:#ae81ff">localhost:5000/ubuntu_ansible</span>

<span style="color:#f92672">before_script</span>:
  - <span style="color:#ae81ff">whoami</span>
  - <span style="color:#ae81ff">apt-get update -qy</span> <span style="color:#75715e">#update system</span>
  - <span style="color:#ae81ff">git submodule update --init</span>
  - <span style="color:#ae81ff">ansible --version</span>
  - <span style="color:#ae81ff">ansible-lint --version</span>
  - <span style="color:#ae81ff">mkdir secret</span> <span style="color:#75715e"># create secret dir</span>
  - <span style="color:#ae81ff">echo &#34;$ANSIBLE_SSHKEY&#34; &gt; secret/ansible.key</span> <span style="color:#75715e"># create priv key from gitlab variable</span>
  - <span style="color:#ae81ff">chmod 400 secret/ansible.key</span>
  - <span style="color:#ae81ff">export ANSIBLE_HOST_KEY_CHECKING=False</span> <span style="color:#75715e"># disable host key checking for ansible</span>

</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#Download base image ubuntu 18.04</span>
FROM ubuntu:18.04

<span style="color:#75715e"># Update Ubuntu Software repository</span>
RUN apt-get -qy update
RUN apt install -qy python software-properties-common git
RUN apt-add-repository --yes --update ppa:ansible/ansible
RUN apt install -qy ansible ansible-lint

CMD <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;/bin/bash&#34;</span><span style="color:#f92672">]</span>
</code></pre></div><h3 id="stages">Stages<a hidden class="anchor" aria-hidden="true" href="#stages">#</a></h3>
<p>We have defined a couple of stages we want to run on certain events in GitLab.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">stages</span>:
  - <span style="color:#ae81ff">verify</span>
  - <span style="color:#ae81ff">prestaging</span>
  - <span style="color:#ae81ff">staging</span>
  - <span style="color:#ae81ff">predeploy</span>
  - <span style="color:#ae81ff">deploy</span>
</code></pre></div><h3 id="verify-commit">Verify commit<a hidden class="anchor" aria-hidden="true" href="#verify-commit">#</a></h3>
<p>For each commit into GitLab there will be a verify pipeline running. That will do an <em>ansible-lint</em> and a <em>ansible-playbook &ndash;check</em>. This is to make sure that the code is syntax error free.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"> <span style="color:#75715e">#verify syntaxs etc...</span>
<span style="color:#f92672">ansible-verify</span>:
  <span style="color:#f92672">stage</span>: <span style="color:#ae81ff">verify</span>
  <span style="color:#f92672">script</span>:
    - <span style="color:#ae81ff">ansible-lint -v *.yml</span>
    - <span style="color:#ae81ff">ansible-playbook --inventory inventory/production --syntax-check *.yml</span>
  <span style="color:#f92672">rules</span>:
    - <span style="color:#f92672">if</span>: <span style="color:#e6db74">&#39;$CI_BUILD_BEFORE_SHA == &#34;0000000000000000000000000000000000000000&#34;&#39;</span>
      <span style="color:#f92672">when</span>: <span style="color:#ae81ff">always</span>
    - <span style="color:#f92672">if</span>: <span style="color:#e6db74">&#39;$CI_COMMIT_BRANCH != &#34;master&#34; &amp;&amp; $CI_COMMIT_BRANCH != &#34;production&#34;&#39;</span>
      <span style="color:#f92672">when</span>: <span style="color:#ae81ff">always</span>
</code></pre></div><figure>
    <img loading="lazy" src="/images/2020/01/Screenshot-from-2020-01-15-14-49-14.png"
         alt="commit to work branch, pass the verify pipeline"/> <figcaption>
            <p>commit to work branch, pass the verify pipeline</p>
        </figcaption>
</figure>

<h3 id="merge-request-to-master-staging">Merge request to master (staging)<a hidden class="anchor" aria-hidden="true" href="#merge-request-to-master-staging">#</a></h3>
<p>When you need to push code to the staging environment you do this via a merge request to master. Then again will the verify stage be runned, but also there wil be a pre-staging and staging pipe be runned. The pre-staging pipeline will do an Ansible ping. To make sure all hosts are up and working for Ansible. If this fails the pipeline will be cancelled. If the staging hosts are ok, the the Ansible playbook will be runned and the code will be commit to master.</p>
<figure>
    <img loading="lazy" src="/images/2020/01/Screenshot-from-2020-01-15-14-51-33.png"
         alt="Create a merge request from work-branch to master (staging)"/> <figcaption>
            <p>Create a merge request from work-branch to master (staging)</p>
        </figcaption>
</figure>

<p>We can tick the option to automatically merge to master when the pipeline succeeds.</p>
<figure>
    <img loading="lazy" src="/images/2020/01/Screenshot-from-2020-01-15-15-00-04.png"
         alt="running staging pipeline"/> <figcaption>
            <p>running staging pipeline</p>
        </figcaption>
</figure>

<p>The yaml code that will check is staging hosts are online and working via Ansible ping. If they are execute the playbook, on success merge to master.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#75715e"># make sure all staging hosts are online and can be manged by ansible if not stop pipeline</span>
<span style="color:#f92672">prestaging</span>:
  <span style="color:#f92672">stage</span>: <span style="color:#ae81ff">prestaging</span>
  <span style="color:#f92672">script</span>:
    - <span style="color:#ae81ff">ansible --private-key secret/ansible.key --user ansible --inventory inventory/staging all -m ping</span>
  <span style="color:#f92672">rules</span>:
    - <span style="color:#f92672">if</span>: <span style="color:#e6db74">&#39;$CI_MERGE_REQUEST_TARGET_BRANCH_NAME == &#34;master&#34;&#39;</span>
      <span style="color:#f92672">when</span>: <span style="color:#ae81ff">always</span>

<span style="color:#75715e"># test playbook on staging envirioment only run on merge requests to master</span>
<span style="color:#f92672">staging</span>:
  <span style="color:#f92672">stage</span>: <span style="color:#ae81ff">staging</span>
  <span style="color:#f92672">script</span>:
    - <span style="color:#ae81ff">./cicd-info.sh &gt; roles/common/files/cicd-info.txt</span> <span style="color:#75715e"># Run script to get GitLab CI env vars. Ansible will copy then to hosts.</span>
    - <span style="color:#ae81ff">ansible-playbook --private-key secret/ansible.key --user ansible --inventory inventory/staging common.yml</span>
  <span style="color:#f92672">rules</span>:
    - <span style="color:#f92672">if</span>: <span style="color:#e6db74">&#39;$CI_MERGE_REQUEST_TARGET_BRANCH_NAME == &#34;master&#34;&#39;</span>
      <span style="color:#f92672">when</span>: <span style="color:#ae81ff">always</span>
</code></pre></div><figure>
    <img loading="lazy" src="/images/2020/01/Screenshot-from-2020-01-15-13-27-02.png"
         alt="merge to master (staging) pipeline"/> <figcaption>
            <p>merge to master (staging) pipeline</p>
        </figcaption>
</figure>

<h3 id="merge-request-to-production-from-master-staging">Merge request to production from master (staging)<a hidden class="anchor" aria-hidden="true" href="#merge-request-to-production-from-master-staging">#</a></h3>
<p>To deploy to production will also happen via a merge request. It is the same principle as from work-brand to master. The only difference is that Ansible will use production hosts.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#75715e"># make sure all production hosts are online and can be manged by ansible if not stop pipeline</span>
<span style="color:#f92672">predeploy</span>:
  <span style="color:#f92672">stage</span>: <span style="color:#ae81ff">predeploy</span>
  <span style="color:#f92672">script</span>:
    - <span style="color:#ae81ff">ansible --private-key secret/ansible.key --user ansible --inventory inventory/production all -m ping</span>
  <span style="color:#f92672">rules</span>:
    - <span style="color:#f92672">if</span>: <span style="color:#e6db74">&#39;$CI_MERGE_REQUEST_TARGET_BRANCH_NAME == &#34;production&#34;&#39;</span>
      <span style="color:#f92672">when</span>: <span style="color:#ae81ff">always</span>

<span style="color:#75715e"># deploy playbooks to production</span>
<span style="color:#f92672">deploy</span>:
  <span style="color:#f92672">stage</span>: <span style="color:#ae81ff">deploy</span>
  <span style="color:#f92672">script</span>:
    - <span style="color:#ae81ff">./cicd-info.sh &gt; roles/common/files/cicd-info.txt</span> <span style="color:#75715e"># Run script to get GitLab CI env vars. Ansible will copy then to hosts.</span>
    - <span style="color:#ae81ff">ansible-playbook --private-key secret/ansible.key --user ansible --inventory inventory/production common.yml</span>
  <span style="color:#f92672">rules</span>:
    - <span style="color:#f92672">if</span>: <span style="color:#e6db74">&#39;$CI_MERGE_REQUEST_TARGET_BRANCH_NAME == &#34;production&#34;&#39;</span>
      <span style="color:#f92672">when</span>: <span style="color:#ae81ff">always</span>
</code></pre></div><figure>
    <img loading="lazy" src="/images/2020/01/Screenshot-from-2020-01-15-15-07-55.png"
         alt="merge to production pipeline"/> <figcaption>
            <p>merge to production pipeline</p>
        </figcaption>
</figure>

<h2 id="job-overview">Job overview<a hidden class="anchor" aria-hidden="true" href="#job-overview">#</a></h2>
<p>Here we see all jobs that are involved from the commit in the work-branch al the way to production. These jobs are lint and syntax checked, have passed staging and have been successful deployed on production.</p>
<figure>
    <img loading="lazy" src="/images/2020/01/Screenshot-from-2020-01-15-15-16-23.png"
         alt="job overview"/> <figcaption>
            <p>job overview</p>
        </figcaption>
</figure>

<h2 id="cicd-infosh__ghost_url__ansible-ci-with-gitlabcicd-infosh"><a href="__GHOST_URL__/ansible-ci-with-gitlab/cicd-info.sh">cicd-info.sh</a><a hidden class="anchor" aria-hidden="true" href="#cicd-infosh__ghost_url__ansible-ci-with-gitlabcicd-infosh">#</a></h2>
<p>I also created a small script, that will gather some usefull GitLab CI envirioment varibles on the runner. This script will put these in a file and Ansible will pick this file up and put the on the hosts.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span>
echo <span style="color:#e6db74">&#34;Gitlab CICD Ansible run info&#34;</span>
echo
echo <span style="color:#e6db74">&#34;started on `date`&#34;</span>
echo <span style="color:#e6db74">&#34;Project name: </span>$CI_PROJECT_NAME<span style="color:#e6db74">&#34;</span>
echo <span style="color:#e6db74">&#34;Commit SHA: </span>$CI_COMMIT_SHORT_SHA<span style="color:#e6db74">&#34;</span>
echo <span style="color:#e6db74">&#34;On runner: </span>$HOSTNAME<span style="color:#e6db74"> with ID: </span>$CI_RUNNER_ID<span style="color:#e6db74">&#34;</span>
echo <span style="color:#e6db74">&#34;Job info url: </span>$CI_JOB_URL<span style="color:#e6db74">&#34;</span>
echo <span style="color:#e6db74">&#34;By user: </span>$GITLAB_USER_LOGIN<span style="color:#e6db74"> &lt;</span>$GITLAB_USER_EMAIL<span style="color:#e6db74">&gt;&#34;</span>
echo <span style="color:#e6db74">&#34;Commit: </span>$CI_COMMIT_TITLE<span style="color:#e6db74">&#34;</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">---
- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Copy GitLab cicd envirioment run to host</span>
  <span style="color:#f92672">copy</span>:
    <span style="color:#f92672">src</span>: <span style="color:#ae81ff">cicd-info.txt</span>
    <span style="color:#f92672">dest</span>: <span style="color:#ae81ff">/etc/cicd-info.txt</span>
    <span style="color:#f92672">owner</span>: <span style="color:#ae81ff">root</span>
    <span style="color:#f92672">group</span>: <span style="color:#ae81ff">root</span>
    <span style="color:#f92672">mode</span>: <span style="color:#e6db74">&#39;0755&#39;</span>
</code></pre></div><p>The output on the hosts will look something like this. With these info we can always look at the latest Ansible run for this host in GitLab.</p>
<pre tabindex="0"><code>0 dennis@ragnarok:~&gt; cat /etc/cicd-info.txt 
Gitlab CICD Ansible run info

started on Wed Jan 15 14:09:34 UTC 2020
Project name: ansible
Commit SHA: ed2cc1b0
On runner: runner-bhpg76e-project-2-concurrent-0dgklh with ID: 2
Job info url: http://192.168.66.148/dkruyt/ansible/-/jobs/192
By user: dkruyt &lt;dennis@nospam.org&gt;
Commit: Merge branch 'work-branch' into 'master'
</code></pre><h2 id="protect-master-and-production-branch">Protect master and production branch<a hidden class="anchor" aria-hidden="true" href="#protect-master-and-production-branch">#</a></h2>
<p>Make sure your master and production branch are protected, so no one can commit directly in to these branches. Because we want to run the correct pipelines on merge requests.</p>
<figure>
    <img loading="lazy" src="/images/2020/01/Screenshot-from-2020-01-15-10-06-53.png"
         alt="protect your branches"/> <figcaption>
            <p>protect your branches</p>
        </figcaption>
</figure>



  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://kruyt.org/tags/ansible/">ansible</a></li>
      <li><a href="https://kruyt.org/tags/cicd/">cicd</a></li>
      <li><a href="https://kruyt.org/tags/pipeline/">pipeline</a></li>
      <li><a href="https://kruyt.org/tags/flow/">flow</a></li>
      <li><a href="https://kruyt.org/tags/git/">git</a></li>
      <li><a href="https://kruyt.org/tags/merge/">merge</a></li>
      <li><a href="https://kruyt.org/tags/cd/">cd</a></li>
      <li><a href="https://kruyt.org/tags/gitlab/">gitlab</a></li>
      <li><a href="https://kruyt.org/tags/ci/">ci</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2021 <a href="https://kruyt.org/">Dennis Kruyt</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
